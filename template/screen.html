<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">

</head>
<link rel="stylesheet" type="text/css" href="bulletScreen.css" />
 
<link rel="stylesheet" type="text/css" href="lottery.css" />
 
<script type="text/javascript" src="http://code.jquery.com/jquery-2.0.3.js"></script>

<script>  
// 展示获取到的弹幕并加入抽奖池
var lottery_arr = [];
var lottery_contrast_arr = [];
var medal_level_min = 1,
    medal_level_max = 20,
    user_level_min = 1,
    user_level_max = 60,
    danmaku_setting,
    pass = 0;
// 普通模式
function lotteryFilter(res) {
  
    //			console.log(res.uid);
    var danmaku_content = '<div class="danmu"><div class="fans-medal-item level-' + res.medal_level +
        '"><span class="label">' + res.medal_name + '</span><span class="level">' + res.medal_level +
        '</span></div><div class="level-' + res.medal_level +
        '" style="display: inline-block;"><span class="level" style="padding-left: 4px;">' + res.name +
        '   :</span>   ' +
        res.text + '</div></div>'
    $('.danmaku_content').eq(0).append(danmaku_content);
    $('.danmaku_content').eq(0).scrollTop($('.danmaku_content')[0].scrollHeight);
    if ($(".danmu").length >= 15) { // 限制显示条数，防卡
        $(".danmu").eq(0).remove()
    }


  
    if ($.inArray(res.uid, lottery_contrast_arr) == -1) {
        var lottery_join =
            '<div class="lottory"><span style="padding-right: 4px;">非洲人</span><div class="fans-medal-item level-' +
            res.medal_level +
            '"><span class="label">' + res.medal_name + '</span><span class="level">' + res.medal_level +
            '</span></div><span style="padding-left: 4px; color: blue;">' + res.name +
            '</span><span style="padding-left: 4px;"> 加入了拉低中奖率的队伍</span></div>'
        $('.lottery_content').eq(0).append(lottery_join);
        $('.lottery_content').eq(0).scrollTop($('.lottery_content')[0].scrollHeight);
        lottery_arr.push([res.uid, res.name, res.medal_name, res.medal_level]);
        lottery_contrast_arr.push(res.uid);
        if ($(".lottory").length >= 15) {
            $(".lottory").eq(0).remove()
        }
        console.log('%c 【' + res.name + '[ uid: ' + res.uid + ' ]】成为了萌萌兽的朋友交易对象', "color: green");
        //					console.log(lottery_arr)
        //					$('.arr_list').remove();
        //					var arr_list = '<div class="arr_list" style="font-size: 12px;">' + lottery_arr + '</div>';
        //					$('.lottery_pool').eq(0).prepend(arr_list);
    } else {
        console.log('%c 【' + res.name + '[ uid: ' + res.uid + ' ]】已经在等待被黑幕的队伍中了！', "color: red");
    }
    $('.lottery_member').remove();
    $('.lottery_info').eq(0).prepend('<div class="lottery_member" style="color: blue; ">当前非洲人的数量为：' +
        lottery_contrast_arr.length + '</div>');
}

window.addEventListener("load", function(evt) {
    var output = document.getElementById("output");
    var input = document.getElementById("input");
    var input_to = document.getElementById("input_to");
    var input_from = document.getElementById("input_from");
    var ws;
    var print = function(message) {
        var d = document.createElement("div");
        d.innerHTML = message;
        output.appendChild(d);
    };
    var p_roomid="5225"
    ws = new WebSocket("ws://" + document.location.host +"/ws?roomid=" + p_roomid + "&username=xaavvcc");
    ws.onopen = function(evt) {
            
    }
    ws.onclose = function(evt) {
        
        ws = null;
    }
    ws.onmessage = function(evt) {
        //print("RESPONSE: " + evt.data);


        // var msg = $("input").val(); 
        //取出输入框内容
        var obj = JSON.parse(evt.data) 
        
        if(msg.length > 200){ 
        
            alert("字数不得超过15个！"); 
            return; 
        } 
        
        var bullet = $("<div>"); 
        //生成一条弹幕 
        bullet.text(obj.from + ': ' + obj.msg); 
        //将输入框内容放置到div中 
        bullet.addClass("bullet"); 
        //为bullet这个div添加样式bullet 
        bullet.css("top",Math.round(Math.random()*500)); 
        //随机设置弹幕位置 
        bullet.css("left","1600px"); 
        bullet.css("font-size",Math.round(Math.random()*60)+12+"px"); 
        bullet.css("color","rgb("+Math.round(Math.random()*255)+","+Math.round(Math.random()*255)+","+Math.round(Math.random()*255)+")"); 
        // alert(window.getComputedStyle(bullet,null).width); 
        bullet.animate({ 
            left:-1000//此处视为bug，应该随着弹幕的长短而变化 
            // 越大越慢
        }, Math.round(Math.random()*9000)+3000,"linear", function(){ 
            bullet.remove(); 
        //当运动结束时，删除弹幕 
        }); 
        
        $(".content").append(bullet);

        lotteryFilter({
            //cmd: body.cmd,
            //color: body.info[0][3],
            uid: obj.from,
            name: obj.from,
            //admin: body.info[2][2],
            //vip: body.info[2][3],
            //svip: body.info[2][4],
            text:"tezt",
            medal_name:  "没勋章",
            medal_level:  "0",
            //user_level: body.info[4][0],
            //guard: body.info[7],
            roomid: p_roomid,
        }) 
        //将弹幕添加到屏幕中 
    

    }
    ws.onerror = function(evt) {
        print("ERROR: " + evt.data);
    } 

    $('.clean').eq(0).bind('click', function () { // 清空弹幕抽奖池
        console.log("good clean")
        $('.danmaku_content').eq(0).empty();
        $('.lottery_info').eq(0).empty();
        $('.lottery_content').eq(0).empty();
        lottery_arr = [];
        lottery_contrast_arr = [];
    })
    $('.storage_clean').eq(0).bind('click', function () { // 清空中奖名单
        $('.winner_list').eq(0).empty();
        sessionStorage.clear();
    })

    document.getElementById("boom").onclick = function (evt) {
        console.log('good boom')
        if (lottery_arr.length) {
            var lucky_numarr = [];
            var lucky_numarrnew = [];
            var winners_arr = [];
            var winners_contrast = [];
            for (var i = 0; i < lottery_arr.length; i++) {
                lucky_numarr.push(i);
            }
            //				console.log(lucky_numarr);
            lucky_numarr.sort(function () {
                return 0.5 - Math.random(); //返回随机正负值  
            });

            function randomSort(arr, newArr) {
                // 如果原数组arr的length值等于1时，原数组只有一个值，其键值为0
                // 同时将这个值push到新数组newArr中
                if (arr.length == 1) {
                    newArr.push(arr[0]);
                    return newArr; // 相当于递归退出
                }
                // 在原数组length基础上取出一个随机数
                var random = Math.ceil(Math.random() * arr.length) - 1;
                // 将原数组中的随机一个值push到新数组newArr中
                newArr.push(arr[random]);
                // 对应删除原数组arr的对应数组项
                arr.splice(random, 1);
                return randomSort(arr, newArr);
            }
            for (var i = 0; i < lucky_numarr.length; i++) {
                randomSort(lucky_numarr, lucky_numarrnew);
            }
            console.log(lucky_numarrnew);
            var winner_amount = $('#winner_amount').val() || 1;
            if (winner_amount % 1 != 0 || winner_amount <= 0 || winner_amount > lottery_arr.length) {
                return alert('无效的抽奖人数');
            }
            var storage_name = '';
            var lucky_dogs;
            
            lucky_dogs = '<div class="lottory">萌萌兽被水淹没，不知所措，经过不断摸索，摸到了下面几条弹幕_(:з」∠)_<br />';
            for (var i = 0; i < winner_amount; i++) {
                if (!lottery_arr[lucky_numarrnew[i]]) {
                    alert('哎呀~没人来交易了……');
                    continue;
                } else if ($.inArray(lottery_arr[lucky_numarrnew[i]][0], winners_contrast) != -
                    1) {
                    if (winner_amount >= lottery_arr.length) {
                        return alert('出错了，去重后设置的中奖人数大于参加抽奖的人数');
                    }
                    winner_amount++;
                    continue;
                } else if (sessionStorage.getItem(lottery_arr[lucky_numarrnew[i]][0])) { // 多次中奖处理机制
                    alert('命运石之门选中了【' + lottery_arr[lucky_numarrnew[i]][1] + '】' + '\n' +
                        '但是你已经被啪过了！' +
                        '\n' +
                        '喜新厌旧的萌萌兽并不想跟你交易第二次' +
                        '\n' + '点击确定换个人交易_(:з」∠)_');
                    winner_amount++;
                    continue;
                } else if (lottery_arr[lucky_numarrnew[i]]) {
                    winners_contrast.push(lottery_arr[lucky_numarrnew[i]][0]);
                    sessionStorage.setItem(lottery_arr[lucky_numarrnew[i]][0], lottery_arr[
                        lucky_numarrnew[
                            i]][1]);
                    lucky_dogs += '<div class="fans-medal-item level-' + lottery_arr[
                            lucky_numarrnew[i]][3] +
                        '"><span class="label">' + lottery_arr[lucky_numarrnew[i]][2] +
                        '</span><span class="level">' + lottery_arr[
                            lucky_numarrnew[i]][3] +
                        '</span></div><span style="padding-left: 4px;"></span><span style="padding-left: 4px; color: blue;">' +
                        lottery_arr[lucky_numarrnew[i]][1] + ' [ uid: ' +
                        lottery_arr[lucky_numarrnew[i]][0] + ' ] :</span> ' + lottery_arr[
                            lucky_numarrnew[i]]
                        [4] + '</span><br />';
                    storage_name += '<span>' + lottery_arr[lucky_numarrnew[i]][1] +
                        ' | </span>';
                }
            }
            lucky_dogs += '<span style="padding-left: 4px;">是直接打死还是走程序？</span></div>';
            if (storage_name) {
                $('.lottory').remove();
                $('.lottery_content').eq(0).append(lucky_dogs);
                $('.winner_list').eq(0).append(storage_name);
            }
            //			lottery_arr.splice(lucky_num, 1);	
        } else {
            alert('抽奖列表为空');
        }

    };
  
    document.getElementById("send").onclick = function(evt) {
        if (!ws) {
            return false;
        }

        msg='{"data_list":[{"from": "'+ input_from.value +'" , "msg":"' + input.value + '","to":"' + input_to.value+'"}] }'
        //print("SEND: " + msg);
        ws.send(msg);
        return false;
    };
  
});
</script>

<body>
    <div class="content"> 
    
    </div> 


    <table>
        <tr><td valign="top" width="50%">
        <p>输入 弹幕内容 和 发送昵称 后，点击发送 进行发送弹幕</p>

        </br></br>
        <form>
        
        <p>发送昵称: <input id="input_from" type="text" value="路人">
            弹幕内容: <input id="input" type="text" value="快乐!">
             <input id="input_to" type="text" value="" hidden>
            
        <button id="send">发送</button>
        </form>
        </td><td valign="top" width="50%">
        <div id="output"></div>
        </td></tr>
    </table>
    <div id="content" class="container-fluid">
	
		<!--<input type="number" placeholder="请输入房间号码,例如5279" id="input"><br />-->
		<div class="row">
			<div class="option col-lg-6 col-md-6 col-sm-6 col-xs-12">
				
			
				
				<div class="input-group">
					<span class="input-group-addon">
						<input class="v-middle" type="checkbox" checked disabled />
						<span class="v-middle">设置中奖人数：</span>
					</span>
					<input class="form-control" type="number" placeholder="请输入数字,默认为1" id="winner_amount" />
				</div>

			</div>
			<div class=" col-lg-6 col-md-6 col-sm-6 col-xs-12">
				<div>中奖名单</div>
				<div class="winner_box">
					<div class="winner_list">

					</div>
				</div>
				<button class="storage_clean btn btn-info">清空中奖名单</button>
			</div>
		</div>

		<div>
			<span style="display: inline-block; width: 49%;">中奖率：1 / 抽奖人数</span>
			<span style="display: inline-block; width: 49%;">中奖率：用户发送的弹幕数 / 总弹幕数</span>
		</div>
	</div>
    <div style="font-size: 0;">
		<button class="start btn btn-success green">开启普通模式</button>
		<button class="start btn btn-success darkgreen">开启刷爆模式</button>
		<!--<button class="end btn btn-danger">停止获取弹幕</button>-->
		<button id="boom" class="boom btn btn-info">停止并黑幕一下</button>
		<button class="clean btn btn-info">清空弹幕和抽奖池</button>
	</div>
	<div style="font-size: 0;">
		<div class="danmaku_pool">
			<div class="danmaku_info">

			</div>
			<div class="danmaku_content">

			</div>
		</div>
		<div class="lottery_pool">
			<div class="lottery_info">

			</div>
			<div class="lottery_content">

			</div>
		</div>
	</div>


</body>
</html>
